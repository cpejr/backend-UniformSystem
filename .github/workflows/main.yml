name: CI

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    # Instala o Node
    - name: Setup Node.js environment
      uses: actions/setup-node@v2
      with:
       node-version: 12.x
    # Passo 1: Instalar as dependências NPM/Yarn
    - name: Install dependencies
      run: npm install

    # Passo 3: Copiar código para a Digital Ocean
    - name: Copy files to Digital Ocean
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        port: ${{secrets.SSH_PORT}}
        username: ${{secrets.SSH_USERNAME}}
        password: ${{secrets.SSH_KEY}}
        source: "., !node_modules"
        target: "~/uniformSystem/backend"
  
    # RUN SCRIPT FOR PRODUCTION
    - name: Run production script
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        port: ${{secrets.SSH_PORT}}
        username: ${{secrets.SSH_USERNAME}}
        password: ${{secrets.SSH_KEY}}
        script: | 
         cd ~/uniformSystem/backend
         npm install
         npx knex migrate:latest
         pm2 restart uniformsystem-backend
